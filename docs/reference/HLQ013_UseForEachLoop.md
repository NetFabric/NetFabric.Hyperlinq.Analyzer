# HLQ013: Use `foreach` loop

## Cause

`for` loop is being used to iterate an array or a span.

## Severity

Warning

## Rule description

Both `for` and `foreach` loops can be used to iterate an array or a span and the code generated by the compiler for both is actually very similar. 
The difference is that the code generated for the `foreach` guarantees the following:

- The collection is a local variable.
- The terminal condition is the length of the collection.

These allow the JIT compiler to drop bounds checking making the iteration more performant. 

### Benchmarks

Source: https://github.com/NetFabric/NetFabric.Hyperlinq.Analyzer/blob/master/NetFabric.Hyperlinq.Analyzer.Benchmarks/HLQ013_UseForEachLoop.cs

```

BenchmarkDotNet v0.13.6, Windows 10 (10.0.19045.3269/22H2/2022Update)
Intel Core i7-7567U CPU 3.50GHz (Kaby Lake), 1 CPU, 4 logical and 2 physical cores
.NET SDK 8.0.100-preview.5.23303.2
  [Host] : .NET 6.0.20 (6.0.2023.32017), X64 RyuJIT AVX2
  .NET 6 : .NET 6.0.20 (6.0.2023.32017), X64 RyuJIT AVX2
  .NET 7 : .NET 7.0.8 (7.0.823.31807), X64 RyuJIT AVX2
  .NET 8 : .NET 8.0.0 (8.0.23.28008), X64 RyuJIT AVX2


```
|        Method |    Job |  Runtime | Count |       Mean |      Error |     StdDev |     Median |        Ratio | RatioSD | Code Size | Allocated | Alloc Ratio |
|-------------- |------- |--------- |------ |-----------:|-----------:|-----------:|-----------:|-------------:|--------:|----------:|----------:|------------:|
|           **For** | **.NET 6** | **.NET 6.0** |    **10** |   **4.619 ns** |  **0.1285 ns** |  **0.3270 ns** |   **4.496 ns** |     **baseline** |        **** |      **68 B** |         **-** |          **NA** |
| ForEach_Array | .NET 6 | .NET 6.0 |    10 |   3.543 ns |  0.1464 ns |  0.4200 ns |   3.358 ns | 1.32x faster |   0.17x |        NA |         - |          NA |
|  ForEach_Span | .NET 6 | .NET 6.0 |    10 |   3.976 ns |  0.1147 ns |  0.2792 ns |   3.870 ns | 1.17x faster |   0.13x |        NA |         - |          NA |
|               |        |          |       |            |            |            |            |              |         |           |           |             |
|           For | .NET 7 | .NET 7.0 |    10 |   4.766 ns |  0.1589 ns |  0.4584 ns |   4.558 ns |     baseline |         |      68 B |         - |          NA |
| ForEach_Array | .NET 7 | .NET 7.0 |    10 |   3.435 ns |  0.1574 ns |  0.4466 ns |   3.280 ns | 1.41x faster |   0.22x |        NA |         - |          NA |
|  ForEach_Span | .NET 7 | .NET 7.0 |    10 |   3.308 ns |  0.1020 ns |  0.2633 ns |   3.179 ns | 1.45x faster |   0.18x |        NA |         - |          NA |
|               |        |          |       |            |            |            |            |              |         |           |           |             |
|           For | .NET 8 | .NET 8.0 |    10 |   4.476 ns |  0.0795 ns |  0.0664 ns |   4.470 ns |     baseline |         |      68 B |         - |          NA |
| ForEach_Array | .NET 8 | .NET 8.0 |    10 |   3.488 ns |  0.1641 ns |  0.4630 ns |   3.253 ns | 1.30x faster |   0.16x |        NA |         - |          NA |
|  ForEach_Span | .NET 8 | .NET 8.0 |    10 |   4.214 ns |  0.2664 ns |  0.7425 ns |   3.850 ns | 1.07x faster |   0.21x |        NA |         - |          NA |
|               |        |          |       |            |            |            |            |              |         |           |           |             |
|           **For** | **.NET 6** | **.NET 6.0** |  **1000** | **601.976 ns** | **12.0539 ns** | **25.4257 ns** | **595.359 ns** |     **baseline** |        **** |      **68 B** |         **-** |          **NA** |
| ForEach_Array | .NET 6 | .NET 6.0 |  1000 | 447.435 ns |  9.7316 ns | 28.5410 ns | 436.909 ns | 1.34x faster |   0.11x |        NA |         - |          NA |
|  ForEach_Span | .NET 6 | .NET 6.0 |  1000 | 498.277 ns |  9.6062 ns | 12.8240 ns | 495.038 ns | 1.21x faster |   0.05x |        NA |         - |          NA |
|               |        |          |       |            |            |            |            |              |         |           |           |             |
|           For | .NET 7 | .NET 7.0 |  1000 | 488.825 ns |  9.6145 ns | 17.8211 ns | 485.061 ns |     baseline |         |      68 B |         - |          NA |
| ForEach_Array | .NET 7 | .NET 7.0 |  1000 | 399.636 ns |  9.6818 ns | 27.6227 ns | 390.421 ns | 1.23x faster |   0.08x |        NA |         - |          NA |
|  ForEach_Span | .NET 7 | .NET 7.0 |  1000 | 373.491 ns |  7.4726 ns | 15.5982 ns | 366.495 ns | 1.31x faster |   0.07x |        NA |         - |          NA |
|               |        |          |       |            |            |            |            |              |         |           |           |             |
|           For | .NET 8 | .NET 8.0 |  1000 | 464.762 ns |  7.9257 ns | 11.8629 ns | 459.148 ns |     baseline |         |      68 B |         - |          NA |
| ForEach_Array | .NET 8 | .NET 8.0 |  1000 | 397.323 ns |  9.5306 ns | 28.1012 ns | 387.040 ns | 1.17x faster |   0.09x |        NA |         - |          NA |
|  ForEach_Span | .NET 8 | .NET 8.0 |  1000 | 390.588 ns |  7.9433 ns | 22.5338 ns | 383.722 ns | 1.20x faster |   0.07x |        NA |         - |          NA |

## How to fix violations

Use `foreach` instead of `for` when iterating over an array or a span.

For partial iterations, use a range-based `foreach` loop.

## When to suppress warnings

When the indexing is required for some reason, e.g. when the index is used to access another array.

## Example of a violation

Full iteration of an array using a `for` loop:

``` csharp
var source = new[] { 1, 2, 3 };
for (var index = 0; index < source.Length; index++)
{
    var item = source[index];
    Console.WriteLine(item);
}
```

Partial iteration of an array using a `for` loop:

``` csharp

``` csharp
var source = new[] { 1, 2, 3 };
// skiping first and last items
for (var index = 1; index < source.Length - 1; index++)
{
    var item = source[index];
    Console.WriteLine(item);
}
```

## Example of how to fix

Full iteration of an array using a `foreach` loop:

``` csharp
var source = new[] { 1, 2, 3 };
foreach (var item in source)
{
    Console.WriteLine(item);
}
```

Partial iteration of an array using a `foreach` loop:

``` csharp
var source = new[] { 1, 2, 3 };
// skiping first and last items
foreach (var item in source[1..^1])
{
    Console.WriteLine(item);
}
```
